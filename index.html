<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube - Tips Music Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.8em;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .content {
            padding: 30px 40px;
        }

        .filters {
            background: #f8f9fc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="date"], select {
            padding: 12px 16px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            min-width: 180px;
        }

        input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.05em;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.9em;
            opacity: 0.95;
        }

        .metric-change.positive { color: #68D391; }
        .metric-change.negative { color: #FC8181; }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.6em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chart-container {
            background: #f8f9fc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2d3748;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 8px 16px;
            border: 2px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .dual-chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .data-table-container {
            background: #f8f9fc;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .positive-change {
            color: #22863a;
            font-weight: 600;
        }

        .negative-change {
            color: #cb2431;
            font-weight: 600;
        }

        .neutral-change {
            color: #6a737d;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .correlation-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 25px;
        }

        .correlation-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .correlation-stat {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .correlation-stat:last-child {
            border-bottom: none;
        }

        .correlation-label {
            font-size: 1.05em;
            opacity: 0.95;
        }

        .correlation-value {
            font-size: 1.2em;
            font-weight: 700;
        }

        .analysis-insights {
            background: #edf2f7;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
            margin-top: 20px;
        }

        .insight-item {
            padding: 12px 0;
            color: #2d3748;
            line-height: 1.7;
            font-size: 1.05em;
        }

        .timestamp {
            text-align: center;
            color: #a0aec0;
            font-size: 0.95em;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        @media (max-width: 1024px) {
            .dual-chart-grid {
                grid-template-columns: 1fr;
            }
            h1 { font-size: 2em; }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        @media (max-width: 600px) {
            .content { padding: 20px; }
            header { padding: 20px; }
            .filters { flex-direction: column; }
            .filter-group { width: 100%; }
            input[type="date"], select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ YouTube - Tips Music</h1>
            <p class="subtitle">Performance Analytics & Stock Price Correlation Dashboard</p>
        </header>

        <div class="content">
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label for="timeframe">üìÖ Time Period</label>
                    <select id="timeframe" onchange="updateDateRange()">
                        <option value="30">Last 30 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last 1 Year</option>
                        <option value="all">All Time (2023-Present)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" value="2023-01-01">
                </div>
                <div class="filter-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <button onclick="loadData()">üìä Load Data</button>
            </div>

            <!-- Key Metrics Summary -->
            <div class="metrics-grid" id="metricsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading metrics...</p>
                </div>
            </div>

            <!-- Daily Views Chart -->
            <div class="section">
                <h2 class="section-title">üìà Daily Views Performance</h2>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Tips Music - Daily Views Trend</div>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleScale('dailyViews', 'linear', this)">Linear</button>
                            <button class="chart-btn" onclick="toggleScale('dailyViews', 'logarithmic', this)">Log</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyViewsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Monthly Growth Chart -->
            <div class="section">
                <h2 class="section-title">üìä Monthly Growth Analysis</h2>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Month-over-Month Views & Growth Rate</div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyGrowthChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stock Price Chart -->
            <div class="section">
                <h2 class="section-title">üíπ Stock Price Performance</h2>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">TIPSMUSIC Stock Price (NSE)</div>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleScale('stockPrice', 'linear', this)">Linear</button>
                            <button class="chart-btn" onclick="toggleScale('stockPrice', 'logarithmic', this)">Log</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="stockPriceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Side-by-Side Comparison -->
            <div class="section">
                <h2 class="section-title">üîó Views vs Stock Price Comparison</h2>
                <div class="dual-chart-grid">
                    <div class="chart-container">
                        <div class="chart-title">Daily Views (7-Day MA)</div>
                        <div class="chart-wrapper" style="height: 300px;">
                            <canvas id="viewsComparisonChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Stock Price (7-Day MA)</div>
                        <div class="chart-wrapper" style="height: 300px;">
                            <canvas id="stockComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Dual-Axis Overlay (Normalized)</div>
                    <div class="chart-wrapper">
                        <canvas id="overlayChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="section">
                <h2 class="section-title">üìã Daily Views Data Table</h2>
                <div class="data-table-container">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Daily Views</th>
                                <th>Change from Previous</th>
                                <th>% Change</th>
                                <th>7-Day MA</th>
                                <th>30-Day MA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">
                                    <div class="spinner"></div>
                                    Loading data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Correlation Analysis -->
            <div class="section">
                <h2 class="section-title">üî¨ Correlation Analysis & Insights</h2>
                <div class="correlation-box" id="correlationBox">
                    <div class="correlation-title">Statistical Analysis</div>
                    <div class="loading">
                        <div class="spinner"></div>
                        Calculating correlations...
                    </div>
                </div>
                <div class="analysis-insights" id="analysisInsights">
                    <div class="loading">Analyzing patterns...</div>
                </div>
            </div>

            <div class="timestamp">
                Last updated: <span id="lastUpdated">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        const charts = {};
        let allData = {};

        // Utility Functions
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        function formatPercent(val) {
            if (!val && val !== 0) return '0%';
            const num = parseFloat(val);
            const prefix = num >= 0 ? '+' : '';
            return prefix + num.toFixed(2) + '%';
        }

        function calculateMA(data, period) {
            const ma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    ma.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    ma.push(sum / period);
                }
            }
            return ma;
        }

        function updateDateRange() {
            const timeframe = document.getElementById('timeframe').value;
            const endDate = new Date();
            const startDate = new Date();

            if (timeframe === 'all') {
                startDate.setFullYear(2023, 0, 1);
            } else {
                startDate.setDate(endDate.getDate() - parseInt(timeframe));
            }

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
        }

        async function fetchSupabase(view, filters = {}, orderBy = 'date.desc', limit = 2000) {
            let url = `${SUPABASE_URL}/rest/v1/${view}?select=*`;
            
            Object.keys(filters).forEach(key => {
                url += `&${key}=eq.${encodeURIComponent(filters[key])}`;
            });
            
            if (orderBy) url += `&order=${orderBy}`;
            if (limit) url += `&limit=${limit}`;

            console.log('Fetching from:', url);

            try {
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`Fetched ${data.length} records from ${view}`);
                return data;
            } catch (error) {
                console.error(`Error fetching ${view}:`, error);
                return [];
            }
        }

        async function loadData() {
            try {
                console.log('Starting data load...');

                // Fetch Tips daily data
                const tipsDaily = await fetchSupabase('daily_label_totals', { label: 'Tips' });
                
                // Fetch stock prices
                const stockData = await fetchSupabase('stock_prices', { symbol: 'TIPSMUSIC' });

                // Fetch monthly data
                const monthlyData = await fetchSupabase('monthly_label_totals', { label: 'Tips' });

                console.log('Data fetched:', {
                    tipsDaily: tipsDaily.length,
                    stockData: stockData.length,
                    monthlyData: monthlyData.length
                });

                if (tipsDaily.length === 0) {
                    alert('No Tips Music data available. Checking connection to Supabase...');
                    return;
                }

                // Filter by date range
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const filteredTips = tipsDaily
                    .filter(d => d.date >= startDate && d.date <= endDate)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const filteredStock = stockData
                    .filter(d => d.date >= startDate && d.date <= endDate && d.close > 0)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const filteredMonthly = monthlyData
                    .filter(d => d.month >= startDate.substring(0, 7) && d.month <= endDate.substring(0, 7))
                    .sort((a, b) => a.month.localeCompare(b.month));

                allData = {
                    tipsDaily: filteredTips,
                    stockData: filteredStock,
                    monthlyData: filteredMonthly
                };

                console.log('Filtered data:', {
                    tips: filteredTips.length,
                    stock: filteredStock.length,
                    monthly: filteredMonthly.length
                });

                updateMetrics();
                updateCharts();
                updateTable();
                updateCorrelation();
                
                document.getElementById('lastUpdated').textContent = 
                    new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Check console for details.');
            }
        }

        function updateMetrics() {
            const { tipsDaily, stockData } = allData;
            if (!tipsDaily || tipsDaily.length === 0) return;

            const latest = tipsDaily[tipsDaily.length - 1];
            const previous = tipsDaily[tipsDaily.length - 2];
            const latestStock = stockData.length > 0 ? stockData[stockData.length - 1] : null;
            const previousStock = stockData.length > 1 ? stockData[stockData.length - 2] : null;

            const dailyViewsChange = previous ? latest.daily_views - previous.daily_views : 0;
            const dailyViewsPct = previous && previous.daily_views > 0 ? 
                ((latest.daily_views - previous.daily_views) / previous.daily_views * 100) : 0;

            const stockChange = latestStock && previousStock ? 
                latestStock.close - previousStock.close : 0;
            const stockPct = latestStock && previousStock && previousStock.close > 0 ?
                ((latestStock.close - previousStock.close) / previousStock.close * 100) : 0;

            const html = `
                <div class="metric-card">
                    <div class="metric-label">Latest Daily Views</div>
                    <div class="metric-value">${formatNumber(latest.daily_views)}</div>
                    <div class="metric-change ${dailyViewsChange >= 0 ? 'positive' : 'negative'}">
                        ${dailyViewsChange >= 0 ? '‚Üë' : '‚Üì'} ${formatNumber(Math.abs(dailyViewsChange))} (${formatPercent(dailyViewsPct)})
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Views</div>
                    <div class="metric-value">${formatNumber(latest.total_views)}</div>
                    <div class="metric-change">Lifetime Total</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Subscribers</div>
                    <div class="metric-value">${formatNumber(latest.total_subscribers)}</div>
                    <div class="metric-change ${latest.daily_subs >= 0 ? 'positive' : 'negative'}">
                        ${latest.daily_subs >= 0 ? '‚Üë' : '‚Üì'} ${formatNumber(Math.abs(latest.daily_subs))} today
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Stock Price (TIPSMUSIC)</div>
                    <div class="metric-value">‚Çπ${latestStock ? latestStock.close.toFixed(2) : 'N/A'}</div>
                    <div class="metric-change ${stockChange >= 0 ? 'positive' : 'negative'}">
                        ${stockChange >= 0 ? '‚Üë' : '‚Üì'} ‚Çπ${Math.abs(stockChange).toFixed(2)} (${formatPercent(stockPct)})
                    </div>
                </div>
            `;

            document.getElementById('metricsGrid').innerHTML = html;
        }

        function updateCharts() {
            const { tipsDaily, stockData, monthlyData } = allData;
            if (!tipsDaily || tipsDaily.length === 0) return;

            const dates = tipsDaily.map(d => d.date);
            const dailyViews = tipsDaily.map(d => d.daily_views || 0);
            const ma7 = calculateMA(dailyViews, 7);
            const ma30 = calculateMA(dailyViews, 30);
            const ma45 = calculateMA(dailyViews, 45);

            // Chart 1: Daily Views with Moving Averages
            if (charts.dailyViews) charts.dailyViews.destroy();
            charts.dailyViews = new Chart(document.getElementById('dailyViewsChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Views',
                            data: dailyViews,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '7-Day MA',
                            data: ma7,
                            borderColor: '#f6ad55',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: '30-Day MA',
                            data: ma30,
                            borderColor: '#fc8181',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: '45-Day MA',
                            data: ma45,
                            borderColor: '#68d391',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            beginAtZero: true,
                            ticks: { callback: v => formatNumber(v) }
                        }
                    }
                }
            });

            // Chart 2: Monthly Growth
            if (monthlyData && monthlyData.length > 0) {
                const months = monthlyData.map(d => d.month);
                const monthlyViews = monthlyData.map(d => d.total_views || 0);
                const monthlyGrowth = monthlyData.map(d => d.mom_views_growth_pct || 0);

                if (charts.monthlyGrowth) charts.monthlyGrowth.destroy();
                charts.monthlyGrowth = new Chart(document.getElementById('monthlyGrowthChart'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Total Views',
                                data: monthlyViews,
                                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'MoM Growth %',
                                data: monthlyGrowth,
                                type: 'line',
                                borderColor: '#fc8181',
                                backgroundColor: 'rgba(252, 129, 129, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                ticks: { callback: v => formatNumber(v) }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                ticks: { callback: v => v + '%' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            // Chart 3: Stock Price with Moving Averages
            if (stockData && stockData.length > 0) {
                const stockDates = stockData.map(d => d.date);
                const stockPrices = stockData.map(d => d.close);
                const stockMA7 = calculateMA(stockPrices, 7);
                const stockMA30 = calculateMA(stockPrices, 30);
                const stockMA45 = calculateMA(stockPrices, 45);

                if (charts.stockPrice) charts.stockPrice.destroy();
                charts.stockPrice = new Chart(document.getElementById('stockPriceChart'), {
                    type: 'line',
                    data: {
                        labels: stockDates,
                        datasets: [
                            {
                                label: 'Stock Price',
                                data: stockPrices,
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: '7-Day MA',
                                data: stockMA7,
                                borderColor: '#f6ad55',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.4
                            },
                            {
                                label: '30-Day MA',
                                data: stockMA30,
                                borderColor: '#fc8181',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.4
                            },
                            {
                                label: '45-Day MA',
                                data: stockMA45,
                                borderColor: '#68d391',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                ticks: { callback: v => '‚Çπ' + v.toFixed(0) }
                            }
                        }
                    }
                });

                // Chart 4: Side-by-side comparison
                if (charts.viewsComparison) charts.viewsComparison.destroy();
                charts.viewsComparison = new Chart(document.getElementById('viewsComparisonChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Daily Views (7-Day MA)',
                            data: ma7,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: v => formatNumber(v) }
                            }
                        }
                    }
                });

                if (charts.stockComparison) charts.stockComparison.destroy();
                charts.stockComparison = new Chart(document.getElementById('stockComparisonChart'), {
                    type: 'line',
                    data: {
                        labels: stockDates,
                        datasets: [{
                            label: 'Stock Price (7-Day MA)',
                            data: stockMA7,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true } },
                        scales: {
                            y: { ticks: { callback: v => '‚Çπ' + v.toFixed(0) } }
                        }
                    }
                });

                // Chart 5: Overlay (Normalized)
                const normalizeData = (data) => {
                    const min = Math.min(...data.filter(v => v !== null));
                    const max = Math.max(...data.filter(v => v !== null));
                    return data.map(v => v !== null ? (v - min) / (max - min) * 100 : null);
                };

                const normalizedViews = normalizeData(ma7);
                const normalizedStock = normalizeData(stockMA7);

                if (charts.overlay) charts.overlay.destroy();
                charts.overlay = new Chart(document.getElementById('overlayChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Daily Views (Normalized)',
                                data: normalizedViews,
                                borderColor: '#667eea',
                                borderWidth: 3,
                                pointRadius: 0,
                                tension: 0.4
                            },
                            {
                                label: 'Stock Price (Normalized)',
                                data: normalizedStock,
                                borderColor: '#764ba2',
                                borderWidth: 3,
                                pointRadius: 0,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: { callback: v => v.toFixed(0) }
                            }
                        }
                    }
                });
            }
        }

        function updateTable() {
            const { tipsDaily } = allData;
            if (!tipsDaily || tipsDaily.length === 0) return;

            const dailyViews = tipsDaily.map(d => d.daily_views || 0);
            const ma7 = calculateMA(dailyViews, 7);
            const ma30 = calculateMA(dailyViews, 30);

            let html = '';
            for (let i = tipsDaily.length - 1; i >= Math.max(0, tipsDaily.length - 50); i--) {
                const current = tipsDaily[i];
                const previous = i > 0 ? tipsDaily[i - 1] : null;
                
                const change = previous ? current.daily_views - previous.daily_views : 0;
                const pctChange = previous && previous.daily_views > 0 ?
                    ((current.daily_views - previous.daily_views) / previous.daily_views * 100) : 0;
                
                const changeClass = change > 0 ? 'positive-change' : change < 0 ? 'negative-change' : 'neutral-change';
                const arrow = change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí';

                html += `
                    <tr>
                        <td><strong>${current.date}</strong></td>
                        <td>${formatNumber(current.daily_views)}</td>
                        <td class="${changeClass}">${arrow} ${formatNumber(Math.abs(change))}</td>
                        <td class="${changeClass}">${formatPercent(pctChange)}</td>
                        <td>${ma7[i] ? formatNumber(ma7[i]) : '-'}</td>
                        <td>${ma30[i] ? formatNumber(ma30[i]) : '-'}</td>
                    </tr>
                `;
            }

            document.querySelector('#dataTable tbody').innerHTML = html;
        }

        function calculateCorrelation(arr1, arr2) {
            const validPairs = [];
            for (let i = 0; i < Math.min(arr1.length, arr2.length); i++) {
                if (arr1[i] !== null && arr2[i] !== null) {
                    validPairs.push([arr1[i], arr2[i]]);
                }
            }

            if (validPairs.length < 2) return 0;

            const n = validPairs.length;
            const mean1 = validPairs.reduce((sum, pair) => sum + pair[0], 0) / n;
            const mean2 = validPairs.reduce((sum, pair) => sum + pair[1], 0) / n;

            const numerator = validPairs.reduce((sum, pair) => 
                sum + (pair[0] - mean1) * (pair[1] - mean2), 0);
            
            const sum1 = validPairs.reduce((sum, pair) => 
                sum + Math.pow(pair[0] - mean1, 2), 0);
            const sum2 = validPairs.reduce((sum, pair) => 
                sum + Math.pow(pair[1] - mean2, 0);

            const denominator = Math.sqrt(sum1 * sum2);
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function updateCorrelation() {
            const { tipsDaily, stockData } = allData;
            if (!tipsDaily || !stockData || tipsDaily.length < 10 || stockData.length < 10) return;

            const dailyViews = tipsDaily.map(d => d.daily_views || 0);
            const ma7Views = calculateMA(dailyViews, 7);
            const ma30Views = calculateMA(dailyViews, 30);

            const stockPrices = stockData.map(d => d.close);
            const stockMA7 = calculateMA(stockPrices, 7);
            const stockMA30 = calculateMA(stockPrices, 30);

            const corr7 = calculateCorrelation(ma7Views, stockMA7);
            const corr30 = calculateCorrelation(ma30Views, stockMA30);
            const corrRaw = calculateCorrelation(dailyViews, stockPrices);

            const strength = Math.abs(corr7) > 0.7 ? 'Strong' : 
                           Math.abs(corr7) > 0.4 ? 'Moderate' : 'Weak';

            const direction = corr7 > 0 ? 'Positive' : 'Negative';

            document.getElementById('correlationBox').innerHTML = `
                <div class="correlation-title">üìä Statistical Correlation Analysis</div>
                <div class="correlation-stat">
                    <span class="correlation-label">7-Day MA Correlation:</span>
                    <span class="correlation-value">${corr7.toFixed(4)}</span>
                </div>
                <div class="correlation-stat">
                    <span class="correlation-label">30-Day MA Correlation:</span>
                    <span class="correlation-value">${corr30.toFixed(4)}</span>
                </div>
                <div class="correlation-stat">
                    <span class="correlation-label">Raw Daily Correlation:</span>
                    <span class="correlation-value">${corrRaw.toFixed(4)}</span>
                </div>
                <div class="correlation-stat">
                    <span class="correlation-label">Relationship Strength:</span>
                    <span class="correlation-value">${strength} ${direction}</span>
                </div>
            `;

            document.getElementById('analysisInsights').innerHTML = `
                <h3 style="color: #2d3748; margin-bottom: 15px; font-size: 1.3em;">üîç Key Insights & Recommendations</h3>
                <div class="insight-item">
                    <strong>üìà Correlation Strength:</strong> The 7-day moving average shows a ${strength.toLowerCase()} ${direction.toLowerCase()} correlation (r = ${corr7.toFixed(3)}) between YouTube daily views and TIPSMUSIC stock price.
                </div>
                <div class="insight-item">
                    <strong>üìä Smoothing Effect:</strong> Using moving averages (especially 7-day and 30-day) helps reduce noise and reveals clearer trends in the relationship between views and stock price.
                </div>
                <div class="insight-item">
                    <strong>üí° Trading Implications:</strong> ${
                        Math.abs(corr7) > 0.5 
                            ? 'The moderate-to-strong correlation suggests that YouTube performance metrics may serve as a leading or coincident indicator for stock price movements. Consider monitoring view trends for potential trading signals.' 
                            : 'The weak correlation indicates that YouTube views alone may not be a reliable predictor of stock price movements. Multiple factors should be considered for trading decisions.'
                    }
                </div>
                <div class="insight-item">
                    <strong>üìâ Methodology:</strong> Best practice is to use 7-day and 30-day moving averages to smooth out daily fluctuations. The 7-day MA provides near-term trends, while the 30-day MA shows longer-term patterns. Compare both to identify momentum shifts.
                </div>
                <div class="insight-item">
                    <strong>‚ö†Ô∏è Disclaimer:</strong> Correlation does not imply causation. Stock prices are influenced by multiple factors including broader market conditions, company fundamentals, and macroeconomic trends. This analysis should be used as one input among many for investment decisions.
                </div>
            `;
        }

        function toggleScale(chartName, scaleType, button) {
            const chart = charts[chartName];
            if (!chart) return;

            // Update button states
            const buttons = button.parentElement.querySelectorAll('.chart-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Update chart scale
            chart.options.scales.y.type = scaleType;
            chart.update();
        }

        // Initialize
        document.getElementById('endDate').valueAsDate = new Date();
        updateDateRange();
        
        window.addEventListener('load', () => {
            console.log('Page loaded, initiating data fetch...');
            loadData();
        });
    </script>
</body>
</html>
