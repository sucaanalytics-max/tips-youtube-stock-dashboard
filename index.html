<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tips Music Analytics Dashboard - Stock vs YouTube Performance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1a202c;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            position: relative;
        }
        
        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #f6ad55, #fc8181, #f687b3);
        }
        
        h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 300;
        }
        
        .main-content {
            padding: 40px;
        }
        
        /* Key Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card.primary { border-left-color: #667eea; }
        .metric-card.success { border-left-color: #48bb78; }
        .metric-card.warning { border-left-color: #ed8936; }
        .metric-card.info { border-left-color: #4299e1; }
        
        .metric-label {
            font-size: 0.85em;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .metric-change {
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .metric-change.positive { color: #22863a; }
        .metric-change.negative { color: #cb2431; }
        .metric-change.neutral { color: #718096; }
        
        /* Filters */
        .filters {
            background: #f7fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Charts Grid */
        .charts-container {
            display: grid;
            gap: 30px;
        }
        
        .chart-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid #e2e8f0;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #edf2f7;
        }
        
        .chart-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        
        .toggle-btn {
            background: #edf2f7;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .toggle-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .chart-wrapper.tall {
            height: 500px;
        }
        
        /* Data Table */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .data-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.95em;
        }
        
        .data-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Analysis Section */
        .analysis-section {
            background: linear-gradient(135deg, #edf2f7 0%, #e6fffa 100%);
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            border-left: 4px solid #38b2ac;
        }
        
        .analysis-section h3 {
            color: #2d3748;
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .correlation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .correlation-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .correlation-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .correlation-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .correlation-value.high { color: #22863a; }
        .correlation-value.medium { color: #ed8936; }
        .correlation-value.low { color: #e53e3e; }
        
        .correlation-description {
            font-size: 0.85em;
            color: #4a5568;
            line-height: 1.5;
        }
        
        .insight-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #4299e1;
        }
        
        .insight-box h4 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        .insight-box ul {
            list-style: none;
            padding: 0;
        }
        
        .insight-box li {
            padding: 8px 0;
            color: #4a5568;
            line-height: 1.6;
            padding-left: 24px;
            position: relative;
        }
        
        .insight-box li::before {
            content: 'üìä';
            position: absolute;
            left: 0;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-size: 0.9em;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-content { padding: 20px; }
            h1 { font-size: 2em; }
            .chart-wrapper { height: 350px; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 640px) {
            .main-content { padding: 15px; }
            h1 { font-size: 1.5em; }
            .metrics-grid { grid-template-columns: 1fr; }
            .filter-row { flex-direction: column; }
            .filter-group { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Tips Music Analytics Dashboard</h1>
            <p class="subtitle">YouTube Performance vs Stock Price Analysis | Real-time Correlation Insights</p>
        </header>

        <div class="main-content">
            <!-- Key Metrics -->
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card primary">
                    <div class="metric-label">Total Views</div>
                    <div class="metric-value" id="totalViews">‚Äî</div>
                    <div class="metric-change" id="totalViewsChange">Loading...</div>
                </div>
                <div class="metric-card success">
                    <div class="metric-label">Avg Daily Views</div>
                    <div class="metric-value" id="avgDailyViews">‚Äî</div>
                    <div class="metric-change" id="avgDailyChange">Loading...</div>
                </div>
                <div class="metric-card warning">
                    <div class="metric-label">Current Stock Price</div>
                    <div class="metric-value" id="currentStock">‚Äî</div>
                    <div class="metric-change" id="stockChange">Loading...</div>
                </div>
                <div class="metric-card info">
                    <div class="metric-label">Correlation (30d)</div>
                    <div class="metric-value" id="correlation30d">‚Äî</div>
                    <div class="metric-change" id="correlationStrength">Loading...</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="timeframe">Time Period</label>
                        <select id="timeframe" onchange="updateDateRange()">
                            <option value="30">Last 30 Days</option>
                            <option value="90" selected>Last 90 Days</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last 1 Year</option>
                            <option value="730">Last 2 Years</option>
                            <option value="all">All Time (2023-Present)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="filter-group">
                        <label for="smoothing">Smoothing (Moving Avg)</label>
                        <select id="smoothing">
                            <option value="1">None (Raw Data)</option>
                            <option value="7">7-Day MA</option>
                            <option value="30">30-Day MA</option>
                            <option value="45" selected>45-Day MA (Recommended)</option>
                        </select>
                    </div>
                    <button onclick="loadData()" style="margin-top: 24px;">üìä Refresh Data</button>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <!-- Daily Views Chart -->
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Daily Views (Tips Music)</h3>
                        <div class="chart-controls">
                            <button class="toggle-btn active" onclick="toggleScale('dailyViews', 'linear')">Linear</button>
                            <button class="toggle-btn" onclick="toggleScale('dailyViews', 'logarithmic')">Log Scale</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyViewsChart"></canvas>
                    </div>
                </div>

                <!-- Monthly Growth Chart -->
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Monthly Views Growth</h3>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyGrowthChart"></canvas>
                    </div>
                </div>

                <!-- Stock Price Chart -->
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">üíπ Stock Price (TIPSMUSIC)</h3>
                        <div class="chart-controls">
                            <button class="toggle-btn active" onclick="toggleScale('stockPrice', 'linear')">Linear</button>
                            <button class="toggle-btn" onclick="toggleScale('stockPrice', 'logarithmic')">Log Scale</button>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="stockPriceChart"></canvas>
                    </div>
                </div>

                <!-- Dual Axis Comparison -->
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">üîó Daily Views vs Stock Price (Dual-Axis)</h3>
                    </div>
                    <div class="chart-wrapper tall">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <!-- Daily Views Table -->
                <div class="chart-box">
                    <div class="chart-header">
                        <h3 class="chart-title">üìã Daily Views Data (Last 30 Days)</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Daily Views</th>
                                    <th>Change from Previous Day</th>
                                    <th>% Change</th>
                                    <th>Stock Price (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="dailyViewsTable">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="spinner"></div>
                                        Loading data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Correlation Analysis -->
            <div class="analysis-section">
                <h3>üîç Correlation Analysis & Insights</h3>
                <div class="correlation-grid" id="correlationGrid">
                    <div class="correlation-card">
                        <div class="correlation-label">7-Day Correlation</div>
                        <div class="correlation-value" id="corr7d">‚Äî</div>
                        <div class="correlation-description" id="corr7dDesc">Loading...</div>
                    </div>
                    <div class="correlation-card">
                        <div class="correlation-label">30-Day Correlation</div>
                        <div class="correlation-value" id="corr30d">‚Äî</div>
                        <div class="correlation-description" id="corr30dDesc">Loading...</div>
                    </div>
                    <div class="correlation-card">
                        <div class="correlation-label">90-Day Correlation</div>
                        <div class="correlation-value" id="corr90d">‚Äî</div>
                        <div class="correlation-description" id="corr90dDesc">Loading...</div>
                    </div>
                    <div class="correlation-card">
                        <div class="correlation-label">Best Lag Period</div>
                        <div class="correlation-value" id="bestLag">‚Äî</div>
                        <div class="correlation-description" id="bestLagDesc">Loading...</div>
                    </div>
                </div>

                <div class="insight-box">
                    <h4>üí° Key Insights & Recommendations</h4>
                    <ul id="insightsList">
                        <li>Analyzing correlation patterns...</li>
                    </ul>
                </div>
            </div>

            <footer>
                <p>Last updated: <span id="lastUpdated">‚Äî</span> | Data source: Supabase (Tips Music + TIPSMUSIC NSE) | 2023-Present</p>
            </footer>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        const charts = {};
        let allData = {};
        let chartScales = {
            dailyViews: 'linear',
            stockPrice: 'linear'
        };

        // ===== UTILITY FUNCTIONS =====
        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        function formatPercent(val) {
            const num = parseFloat(val);
            const prefix = num >= 0 ? '+' : '';
            return prefix + num.toFixed(2) + '%';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function calculateMA(data, period) {
            const ma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    ma.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    ma.push(sum / period);
                }
            }
            return ma;
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            if (n === 0 || n !== y.length) return 0;

            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            const numerator = x.reduce((sum, xi, i) => sum + (xi - meanX) * (y[i] - meanY), 0);
            const denomX = Math.sqrt(x.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0));
            const denomY = Math.sqrt(y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0));

            return numerator / (denomX * denomY);
        }

        function getCorrelationStrength(r) {
            const abs = Math.abs(r);
            if (abs >= 0.7) return 'Strong';
            if (abs >= 0.4) return 'Moderate';
            return 'Weak';
        }

        function getCorrelationClass(r) {
            const abs = Math.abs(r);
            if (abs >= 0.7) return 'high';
            if (abs >= 0.4) return 'medium';
            return 'low';
        }

        // ===== DATE RANGE MANAGEMENT =====
        function updateDateRange() {
            const timeframe = document.getElementById('timeframe').value;
            const endDate = new Date();
            const startDate = new Date();

            if (timeframe === 'all') {
                startDate.setFullYear(2023, 0, 1);
            } else {
                startDate.setDate(endDate.getDate() - parseInt(timeframe));
            }

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
        }

        // ===== API CALLS =====
        async function fetchSupabase(view, filters = {}, orderBy = 'date.desc', limit = 2000) {
            let url = `${SUPABASE_URL}/rest/v1/${view}?select=*`;
            
            Object.keys(filters).forEach(key => {
                url += `&${key}=eq.${encodeURIComponent(filters[key])}`;
            });
            
            if (orderBy) url += `&order=${orderBy}`;
            if (limit) url += `&limit=${limit}`;

            try {
                const response = await axios.get(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                return response.data;
            } catch (error) {
                console.error(`Error fetching ${view}:`, error);
                return [];
            }
        }

        // ===== DATA LOADING =====
        async function loadData() {
            try {
                // Fetch unified data (has both views and stock price)
                const unifiedData = await fetchSupabase('unified_analysis', {}, 'date.desc', 2000);
                
                // Fetch daily label totals for Tips
                const tipsDaily = await fetchSupabase('daily_label_totals', { label: 'Tips' }, 'date.desc', 2000);

                if (!unifiedData || unifiedData.length === 0) {
                    alert('No data available. Please check Supabase connection.');
                    return;
                }

                // Filter out records with 0 stock price
                const validData = unifiedData.filter(d => d.stock_price && d.stock_price > 0);

                allData = {
                    unified: validData.reverse(), // Oldest first for charting
                    tipsDaily: tipsDaily.reverse()
                };

                updateMetrics();
                updateCharts();
                updateTable();
                updateCorrelationAnalysis();
                
                document.getElementById('lastUpdated').textContent = 
                    new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Check console for details.');
            }
        }

        // ===== METRICS UPDATE =====
        function updateMetrics() {
            const { unified, tipsDaily } = allData;
            if (!unified || unified.length === 0) return;

            const latest = unified[unified.length - 1];
            const previous = unified[unified.length - 2];
            const latestTips = tipsDaily[tipsDaily.length - 1];
            const previousTips = tipsDaily[tipsDaily.length - 2];

            // Total Views
            document.getElementById('totalViews').textContent = formatNumber(latestTips.total_views);
            
            // Avg Daily Views (last 30 days)
            const last30Days = unified.slice(-30);
            const avgViews = last30Days.reduce((sum, d) => sum + (d.daily_views_change || 0), 0) / 30;
            document.getElementById('avgDailyViews').textContent = formatNumber(avgViews);
            
            const viewsChange = ((latestTips.daily_views - previousTips.daily_views) / previousTips.daily_views) * 100;
            document.getElementById('avgDailyChange').innerHTML = `
                <span class="${viewsChange >= 0 ? 'positive' : 'negative'}">
                    ${formatPercent(viewsChange)} vs yesterday
                </span>
            `;

            // Stock Price
            document.getElementById('currentStock').textContent = '‚Çπ' + latest.stock_price.toFixed(2);
            const stockChange = ((latest.stock_price - previous.stock_price) / previous.stock_price) * 100;
            document.getElementById('stockChange').innerHTML = `
                <span class="${stockChange >= 0 ? 'positive' : 'negative'}">
                    ${formatPercent(stockChange)} vs yesterday
                </span>
            `;

            // 30-Day Correlation
            const views30d = last30Days.map(d => d.tips_views || 0);
            const prices30d = last30Days.map(d => d.stock_price || 0);
            const corr30 = calculateCorrelation(views30d, prices30d);
            
            document.getElementById('correlation30d').textContent = corr30.toFixed(3);
            document.getElementById('correlationStrength').innerHTML = `
                <span class="${getCorrelationClass(corr30)}">
                    ${getCorrelationStrength(corr30)} ${corr30 >= 0 ? 'positive' : 'negative'} correlation
                </span>
            `;
        }

        // ===== CHARTS UPDATE =====
        function updateCharts() {
            const { unified } = allData;
            if (!unified || unified.length === 0) return;

            const smoothing = parseInt(document.getElementById('smoothing').value);
            
            // Get date-filtered data
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            const filteredData = unified.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate;
            });

            const dates = filteredData.map(d => d.date);
            const rawViews = filteredData.map(d => d.daily_views_change || 0);
            const rawPrices = filteredData.map(d => d.stock_price || 0);

            // Apply smoothing
            const views = smoothing > 1 ? calculateMA(rawViews, smoothing) : rawViews;
            const prices = smoothing > 1 ? calculateMA(rawPrices, smoothing) : rawPrices;

            // Chart 1: Daily Views
            updateDailyViewsChart(dates, views, rawViews, smoothing);

            // Chart 2: Monthly Growth
            updateMonthlyGrowthChart();

            // Chart 3: Stock Price
            updateStockPriceChart(dates, prices, rawPrices, smoothing);

            // Chart 4: Comparison
            updateComparisonChart(dates, views, prices, smoothing);
        }

        function updateDailyViewsChart(dates, views, rawViews, smoothing) {
            if (charts.dailyViews) charts.dailyViews.destroy();

            const datasets = [{
                label: smoothing > 1 ? `${smoothing}-Day MA of Daily Views` : 'Daily Views',
                data: views,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: smoothing > 1 ? 0 : 2
            }];

            if (smoothing > 1) {
                datasets.push({
                    label: 'Raw Daily Views',
                    data: rawViews,
                    borderColor: '#cbd5e0',
                    backgroundColor: 'rgba(203, 213, 224, 0.05)',
                    borderWidth: 1,
                    tension: 0.1,
                    fill: false,
                    pointRadius: 0
                });
            }

            charts.dailyViews = new Chart(document.getElementById('dailyViewsChart'), {
                type: 'line',
                data: { labels: dates, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: chartScales.dailyViews,
                            beginAtZero: chartScales.dailyViews === 'linear',
                            ticks: { callback: v => formatNumber(v) }
                        }
                    }
                }
            });
        }

        function updateMonthlyGrowthChart() {
            const { tipsDaily } = allData;
            if (!tipsDaily) return;

            // Group by month
            const monthlyData = {};
            tipsDaily.forEach(d => {
                const month = d.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { totalViews: 0, count: 0 };
                }
                monthlyData[month].totalViews += d.daily_views || 0;
                monthlyData[month].count++;
            });

            const months = Object.keys(monthlyData).sort();
            const monthlyViews = months.map(m => monthlyData[m].totalViews);
            const monthlyGrowth = [];

            for (let i = 1; i < monthlyViews.length; i++) {
                const growth = ((monthlyViews[i] - monthlyViews[i-1]) / monthlyViews[i-1]) * 100;
                monthlyGrowth.push(growth);
            }

            if (charts.monthlyGrowth) charts.monthlyGrowth.destroy();

            charts.monthlyGrowth = new Chart(document.getElementById('monthlyGrowthChart'), {
                type: 'bar',
                data: {
                    labels: months.slice(1),
                    datasets: [
                        {
                            label: 'Monthly Total Views',
                            data: monthlyViews.slice(1),
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'MoM Growth %',
                            data: monthlyGrowth,
                            type: 'line',
                            borderColor: '#f6ad55',
                            backgroundColor: 'rgba(246, 173, 85, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { callback: v => formatNumber(v) }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { callback: v => v.toFixed(1) + '%' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function updateStockPriceChart(dates, prices, rawPrices, smoothing) {
            if (charts.stockPrice) charts.stockPrice.destroy();

            const datasets = [{
                label: smoothing > 1 ? `${smoothing}-Day MA of Stock Price` : 'Stock Price',
                data: prices,
                borderColor: '#764ba2',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: smoothing > 1 ? 0 : 2
            }];

            if (smoothing > 1) {
                datasets.push({
                    label: 'Raw Stock Price',
                    data: rawPrices,
                    borderColor: '#cbd5e0',
                    backgroundColor: 'rgba(203, 213, 224, 0.05)',
                    borderWidth: 1,
                    tension: 0.1,
                    fill: false,
                    pointRadius: 0
                });
            }

            charts.stockPrice = new Chart(document.getElementById('stockPriceChart'), {
                type: 'line',
                data: { labels: dates, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return context.dataset.label + ': ‚Çπ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: chartScales.stockPrice,
                            ticks: { callback: v => '‚Çπ' + v.toFixed(0) }
                        }
                    }
                }
            });
        }

        function updateComparisonChart(dates, views, prices, smoothing) {
            if (charts.comparison) charts.comparison.destroy();

            charts.comparison = new Chart(document.getElementById('comparisonChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: smoothing > 1 ? `Daily Views (${smoothing}d MA)` : 'Daily Views',
                            data: views,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        },
                        {
                            label: smoothing > 1 ? `Stock Price (${smoothing}d MA)` : 'Stock Price',
                            data: prices,
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Daily Views' },
                            ticks: { callback: v => formatNumber(v) }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Stock Price (‚Çπ)' },
                            ticks: { callback: v => '‚Çπ' + v.toFixed(0) },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // ===== TABLE UPDATE =====
        function updateTable() {
            const { unified } = allData;
            if (!unified || unified.length === 0) return;

            const last30 = unified.slice(-30).reverse();
            
            let html = '';
            last30.forEach((row, i) => {
                const prev = last30[i + 1];
                const change = prev ? row.daily_views_change - prev.daily_views_change : 0;
                const pctChange = prev && prev.daily_views_change ? (change / prev.daily_views_change) * 100 : 0;
                
                html += `
                    <tr>
                        <td><strong>${formatDate(row.date)}</strong></td>
                        <td>${formatNumber(row.daily_views_change || 0)}</td>
                        <td style="color: ${change >= 0 ? '#22863a' : '#cb2431'}; font-weight: 600;">
                            ${change >= 0 ? '+' : ''}${formatNumber(change)}
                        </td>
                        <td style="color: ${pctChange >= 0 ? '#22863a' : '#cb2431'}; font-weight: 600;">
                            ${formatPercent(pctChange)}
                        </td>
                        <td><strong>‚Çπ${row.stock_price.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            document.getElementById('dailyViewsTable').innerHTML = html;
        }

        // ===== CORRELATION ANALYSIS =====
        function updateCorrelationAnalysis() {
            const { unified } = allData;
            if (!unified || unified.length < 30) return;

            const last7 = unified.slice(-7);
            const last30 = unified.slice(-30);
            const last90 = unified.slice(-90);

            // Calculate correlations
            const corr7d = calculateCorrelation(
                last7.map(d => d.daily_views_change || 0),
                last7.map(d => d.stock_price || 0)
            );
            const corr30d = calculateCorrelation(
                last30.map(d => d.daily_views_change || 0),
                last30.map(d => d.stock_price || 0)
            );
            const corr90d = calculateCorrelation(
                last90.map(d => d.daily_views_change || 0),
                last90.map(d => d.stock_price || 0)
            );

            // Update correlation cards
            document.getElementById('corr7d').textContent = corr7d.toFixed(3);
            document.getElementById('corr7d').className = 'correlation-value ' + getCorrelationClass(corr7d);
            document.getElementById('corr7dDesc').textContent = `${getCorrelationStrength(corr7d)} ${corr7d >= 0 ? 'positive' : 'negative'} correlation`;

            document.getElementById('corr30d').textContent = corr30d.toFixed(3);
            document.getElementById('corr30d').className = 'correlation-value ' + getCorrelationClass(corr30d);
            document.getElementById('corr30dDesc').textContent = `${getCorrelationStrength(corr30d)} ${corr30d >= 0 ? 'positive' : 'negative'} correlation`;

            document.getElementById('corr90d').textContent = corr90d.toFixed(3);
            document.getElementById('corr90d').className = 'correlation-value ' + getCorrelationClass(corr90d);
            document.getElementById('corr90dDesc').textContent = `${getCorrelationStrength(corr90d)} ${corr90d >= 0 ? 'positive' : 'negative'} correlation`;

            // Find best lag
            const bestLag = findBestLag(unified);
            document.getElementById('bestLag').textContent = bestLag.lag + ' days';
            document.getElementById('bestLag').className = 'correlation-value ' + getCorrelationClass(bestLag.correlation);
            document.getElementById('bestLagDesc').textContent = `Views from ${bestLag.lag} days ago correlate at ${bestLag.correlation.toFixed(3)}`;

            // Generate insights
            generateInsights(corr7d, corr30d, corr90d, bestLag);
        }

        function findBestLag(data) {
            let bestLag = { lag: 0, correlation: 0 };
            
            for (let lag = 0; lag <= 30; lag++) {
                if (data.length <= lag) continue;
                
                const views = data.slice(0, -lag || undefined).map(d => d.daily_views_change || 0);
                const prices = data.slice(lag).map(d => d.stock_price || 0);
                
                const corr = calculateCorrelation(views, prices);
                
                if (Math.abs(corr) > Math.abs(bestLag.correlation)) {
                    bestLag = { lag, correlation: corr };
                }
            }
            
            return bestLag;
        }

        function generateInsights(corr7d, corr30d, corr90d, bestLag) {
            const insights = [];

            // Trend analysis
            if (corr7d > 0.5 && corr30d > 0.5) {
                insights.push('Strong positive correlation detected: YouTube views are moving in tandem with stock price in both short and medium term.');
            } else if (corr7d < -0.5 && corr30d < -0.5) {
                insights.push('Strong negative correlation: Stock price tends to move opposite to YouTube views - unusual pattern requiring investigation.');
            } else {
                insights.push('Weak to moderate correlation: YouTube views may not be a strong leading indicator for stock price movements.');
            }

            // Lag insights
            if (Math.abs(bestLag.correlation) > 0.6) {
                insights.push(`Best predictive signal: Views from ${bestLag.lag} days ago show strong correlation (${bestLag.correlation.toFixed(3)}) with current stock price.`);
            }

            // Smoothing recommendation
            insights.push('Recommendation: Use 45-day moving average to reduce noise and identify true trends. Short-term fluctuations (7-day) may be misleading.');

            // Timeframe analysis
            if (Math.abs(corr90d) > Math.abs(corr30d)) {
                insights.push('Long-term correlation (90d) is stronger than short-term - suggests YouTube performance impacts stock price over extended periods.');
            } else {
                insights.push('Short-term correlation is stronger - suggests market reacts relatively quickly to YouTube performance changes.');
            }

            // Trading signal
            if (Math.abs(bestLag.correlation) > 0.7) {
                insights.push(`‚ö†Ô∏è Strong trading signal detected: Monitor views at ${bestLag.lag}-day lag for potential stock price predictions.`);
            }

            // Update insights list
            const list = document.getElementById('insightsList');
            list.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }

        // ===== TOGGLE SCALE =====
        function toggleScale(chartType, scale) {
            chartScales[chartType] = scale;
            
            // Update button states
            const buttons = event.target.parentElement.children;
            Array.from(buttons).forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateCharts();
        }

        // ===== INITIALIZATION =====
        document.getElementById('endDate').valueAsDate = new Date();
        updateDateRange();
        
        window.addEventListener('load', () => {
            loadData();
        });
    </script>
</body>
</html>
