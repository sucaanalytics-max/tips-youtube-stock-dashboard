<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youtube - Tips Music Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            line-height: 1.6;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
        }

        /* Date Filter */
        .filters {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #cbd5e0;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px 16px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1em;
            transition: all 0.3s;
            min-width: 180px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .metric-card h3 {
            color: #94a3b8;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2.2em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .metric-card .change {
            font-size: 0.9em;
            font-weight: 600;
        }

        .metric-card .change.positive {
            color: #10b981;
        }

        .metric-card .change.negative {
            color: #ef4444;
        }

        /* Chart Containers */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .chart-card h2 {
            font-size: 1.4em;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
        }

        .chart-wrapper.tall {
            height: 550px;
        }

        /* Correlation Section */
        .correlation-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #334155;
        }

        .correlation-section h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
        }

        .correlation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .correlation-stat {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .correlation-stat h4 {
            color: #94a3b8;
            font-size: 0.85em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .correlation-stat .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .correlation-insight {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .correlation-insight p {
            color: #cbd5e0;
            line-height: 1.8;
        }

        /* Table */
        .table-card {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .data-table thead {
            background: #0f172a;
            position: sticky;
            top: 0;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #334155;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
        }

        .data-table tbody tr:hover {
            background: #0f172a;
        }

        .table-card h2 {
            font-size: 1.4em;
            font-weight: 600;
            color: #fff;
            margin-bottom: 20px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .spinner {
            border: 4px solid #334155;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 0.9em;
        }

        /* Toggle Buttons */
        .chart-toggles {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-btn {
            padding: 8px 16px;
            background: #0f172a;
            border: 2px solid #334155;
            color: #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .chart-wrapper { height: 350px; }
            .filters { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group select,
            .filter-group input { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>üéµ Youtube - Tips Music</h1>
            <p>Performance Analytics & Stock Price Correlation Dashboard</p>
        </div>

        <!-- Date Filter -->
        <div class="filters">
            <div class="filter-group">
                <label>Time Period</label>
                <select id="timeframe" onchange="updateDateRange()">
                    <option value="30">Last 30 Days</option>
                    <option value="90" selected>Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365">Last 1 Year</option>
                    <option value="all">All Time (2023-Present)</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filter-group" id="customStartGroup" style="display: none;">
                <label>Start Date</label>
                <input type="date" id="startDate" value="2023-01-01">
            </div>
            <div class="filter-group" id="customEndGroup" style="display: none;">
                <label>End Date</label>
                <input type="date" id="endDate">
            </div>
            <button onclick="loadData()">üìä Load Data</button>
        </div>

        <!-- Key Metrics Summary -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <h3>Total Subscribers</h3>
                <div class="value" id="totalSubs">-</div>
                <div class="change" id="subsChange">-</div>
            </div>
            <div class="metric-card">
                <h3>Daily Views (Latest)</h3>
                <div class="value" id="dailyViews">-</div>
                <div class="change" id="viewsChange">-</div>
            </div>
            <div class="metric-card">
                <h3>Current Stock Price</h3>
                <div class="value" id="stockPrice">-</div>
                <div class="change" id="stockChange">-</div>
            </div>
            <div class="metric-card">
                <h3>7-Day Avg Views</h3>
                <div class="value" id="avg7Days">-</div>
                <div class="change" id="avg7Change">-</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <!-- Daily Views Chart -->
            <div class="chart-card">
                <h2>üìà Daily Views - Tips Music</h2>
                <div class="chart-toggles">
                    <button class="toggle-btn active" onclick="toggleScale('dailyViews', 'linear')">Linear Scale</button>
                    <button class="toggle-btn" onclick="toggleScale('dailyViews', 'logarithmic')">Logarithmic Scale</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="dailyViewsChart"></canvas>
                </div>
            </div>

            <!-- Monthly Growth Chart -->
            <div class="chart-card">
                <h2>üìä Monthly Views Growth</h2>
                <div class="chart-wrapper">
                    <canvas id="monthlyGrowthChart"></canvas>
                </div>
            </div>

            <!-- Stock Price Chart -->
            <div class="chart-card">
                <h2>üíπ Stock Price (TIPSMUSIC) - NSE</h2>
                <div class="chart-toggles">
                    <button class="toggle-btn active" onclick="toggleScale('stockPrice', 'linear')">Linear Scale</button>
                    <button class="toggle-btn" onclick="toggleScale('stockPrice', 'logarithmic')">Logarithmic Scale</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="stockPriceChart"></canvas>
                </div>
            </div>

            <!-- Side-by-Side Comparison -->
            <div class="chart-card">
                <h2>üîó Daily Views vs Stock Price (Dual-Axis Comparison)</h2>
                <div class="chart-wrapper tall">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Correlation Analysis -->
        <div class="correlation-section">
            <h2>üîç Correlation Analysis: Daily Views vs Stock Price</h2>
            <div class="correlation-stats" id="correlationStats">
                <div class="correlation-stat">
                    <h4>Pearson Correlation</h4>
                    <div class="stat-value" id="pearsonCorr">-</div>
                </div>
                <div class="correlation-stat">
                    <h4>Correlation Strength</h4>
                    <div class="stat-value" id="corrStrength">-</div>
                </div>
                <div class="correlation-stat">
                    <h4>Best Lag Period</h4>
                    <div class="stat-value" id="bestLag">-</div>
                </div>
                <div class="correlation-stat">
                    <h4>Data Points</h4>
                    <div class="stat-value" id="dataPoints">-</div>
                </div>
            </div>
            <div class="correlation-insight">
                <p id="correlationInsight">Loading correlation analysis...</p>
            </div>
        </div>

        <!-- Daily Views Table -->
        <div class="table-card">
            <h2>üìã Daily Views Data - Tips Music</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Daily Views</th>
                        <th>Change from Prev Day</th>
                        <th>Change %</th>
                        <th>7-Day Avg</th>
                        <th>30-Day Avg</th>
                        <th>Stock Price (‚Çπ)</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="footer">
            Last updated: <span id="lastUpdated">-</span><br>
            Data source: Supabase | Stock: NSE India (TIPSMUSIC)
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        const charts = {};
        let allData = {};
        const scaleSettings = {
            dailyViews: 'linear',
            stockPrice: 'linear'
        };

        // Utility Functions
        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num?.toFixed(0) || '0';
        }

        function formatPercent(val) {
            const num = parseFloat(val);
            if (isNaN(num)) return '0%';
            const prefix = num >= 0 ? '+' : '';
            return prefix + num.toFixed(2) + '%';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function calculateSMA(data, period) {
            const sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    sma.push(null);
                } else {
                    const slice = data.slice(i - period + 1, i + 1).filter(v => v !== null && v !== undefined);
                    const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
                    sma.push(avg);
                }
            }
            return sma;
        }

        function calculateCorrelation(arr1, arr2) {
            const validPairs = [];
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== null && arr1[i] !== undefined && 
                    arr2[i] !== null && arr2[i] !== undefined &&
                    arr2[i] !== 0) {
                    validPairs.push([arr1[i], arr2[i]]);
                }
            }

            if (validPairs.length < 2) return 0;

            const n = validPairs.length;
            const mean1 = validPairs.reduce((sum, pair) => sum + pair[0], 0) / n;
            const mean2 = validPairs.reduce((sum, pair) => sum + pair[1], 0) / n;

            const numerator = validPairs.reduce((sum, pair) => 
                sum + (pair[0] - mean1) * (pair[1] - mean2), 0);
            
            const sum1 = validPairs.reduce((sum, pair) => 
                sum + Math.pow(pair[0] - mean1, 2), 0);
            const sum2 = validPairs.reduce((sum, pair) => 
                sum + Math.pow(pair[1] - mean2, 2), 0);

            if (sum1 === 0 || sum2 === 0) return 0;
            return numerator / Math.sqrt(sum1 * sum2);
        }

        // Date Range Functions
        function updateDateRange() {
            const timeframe = document.getElementById('timeframe').value;
            const endDate = new Date();
            const startDate = new Date();

            if (timeframe === 'custom') {
                document.getElementById('customStartGroup').style.display = 'flex';
                document.getElementById('customEndGroup').style.display = 'flex';
                return;
            }

            document.getElementById('customStartGroup').style.display = 'none';
            document.getElementById('customEndGroup').style.display = 'none';

            if (timeframe === 'all') {
                startDate.setFullYear(2023, 0, 1);
            } else {
                startDate.setDate(endDate.getDate() - parseInt(timeframe));
            }

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
        }

        // Data Loading
        async function fetchSupabase(view, filters = {}, orderBy = null, limit = 2000) {
            let url = `${SUPABASE_URL}/rest/v1/${view}?select=*`;
            
            Object.keys(filters).forEach(key => {
                url += `&${key}=eq.${encodeURIComponent(filters[key])}`;
            });
            
            if (orderBy) url += `&order=${orderBy}`;
            if (limit) url += `&limit=${limit}`;

            try {
                const response = await axios.get(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                return response.data;
            } catch (error) {
                console.error(`Error fetching ${view}:`, error);
                return [];
            }
        }

        async function loadData() {
            try {
                // Fetch unified analysis data
                const unifiedData = await fetchSupabase('unified_analysis', 
                    { label: 'Tips' }, 
                    'date.desc', 
                    2000
                );

                // Fetch daily label totals
                const dailyTotals = await fetchSupabase('daily_label_totals',
                    { label: 'Tips' },
                    'date.desc',
                    2000
                );

                // Fetch monthly totals
                const monthlyTotals = await fetchSupabase('monthly_label_totals',
                    { label: 'Tips' },
                    'month.desc',
                    50
                );

                if (!unifiedData || unifiedData.length === 0) {
                    alert('No data available. Please check Supabase connection.');
                    return;
                }

                allData = {
                    unified: unifiedData.reverse(),
                    daily: dailyTotals.reverse(),
                    monthly: monthlyTotals.reverse()
                };

                updateMetrics();
                updateCharts();
                updateTable();
                updateCorrelationAnalysis();
                
                document.getElementById('lastUpdated').textContent = 
                    new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Check console for details.');
            }
        }

        // Update Key Metrics
        function updateMetrics() {
            const { daily, unified } = allData;
            if (!daily || daily.length === 0) return;

            const latest = daily[daily.length - 1];
            const previous = daily[daily.length - 2];
            const latestUnified = unified.find(d => d.stock_price > 0);

            // Total Subscribers
            document.getElementById('totalSubs').textContent = formatNumber(latest.total_subscribers);
            const subsChange = latest.total_subscribers - (previous?.total_subscribers || latest.total_subscribers);
            document.getElementById('subsChange').textContent = `${subsChange >= 0 ? '+' : ''}${formatNumber(subsChange)} today`;
            document.getElementById('subsChange').className = `change ${subsChange >= 0 ? 'positive' : 'negative'}`;

            // Daily Views
            document.getElementById('dailyViews').textContent = formatNumber(latest.daily_views);
            const viewsChangeVal = latest.daily_views - (previous?.daily_views || latest.daily_views);
            const viewsChangePct = previous ? ((viewsChangeVal / previous.daily_views) * 100) : 0;
            document.getElementById('viewsChange').textContent = `${formatPercent(viewsChangePct)} vs yesterday`;
            document.getElementById('viewsChange').className = `change ${viewsChangeVal >= 0 ? 'positive' : 'negative'}`;

            // Stock Price
            if (latestUnified && latestUnified.stock_price > 0) {
                document.getElementById('stockPrice').textContent = '‚Çπ' + latestUnified.stock_price.toFixed(2);
                const stockChangeVal = latestUnified.daily_return_pct || 0;
                document.getElementById('stockChange').textContent = `${formatPercent(stockChangeVal)} today`;
                document.getElementById('stockChange').className = `change ${stockChangeVal >= 0 ? 'positive' : 'negative'}`;
            }

            // 7-Day Average
            const last7 = daily.slice(-7).map(d => d.daily_views);
            const avg7 = last7.reduce((a, b) => a + b, 0) / last7.length;
            document.getElementById('avg7Days').textContent = formatNumber(avg7);
            document.getElementById('avg7Change').textContent = '7-day rolling average';
        }

        // Update Charts
        function updateCharts() {
            const { unified, daily, monthly } = allData;
            if (!unified || unified.length === 0) return;

            // Filter data for date range
            const filteredUnified = unified.filter(d => {
                const date = new Date(d.date);
                return d.stock_price !== null && d.stock_price > 0;
            });

            const dates = filteredUnified.map(d => d.date);
            const dailyViews = filteredUnified.map(d => d.daily_views_change || 0);
            const stockPrices = filteredUnified.map(d => d.stock_price);

            // Calculate moving averages
            const sma7 = calculateSMA(dailyViews, 7);
            const sma30 = calculateSMA(dailyViews, 30);
            const sma45 = calculateSMA(dailyViews, 45);

            const stockSma7 = calculateSMA(stockPrices, 7);
            const stockSma30 = calculateSMA(stockPrices, 30);
            const stockSma45 = calculateSMA(stockPrices, 45);

            // Chart 1: Daily Views
            if (charts.dailyViews) charts.dailyViews.destroy();
            charts.dailyViews = new Chart(document.getElementById('dailyViewsChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Views',
                            data: dailyViews,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true
                        },
                        {
                            label: '7-Day MA',
                            data: sma7,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: '30-Day MA',
                            data: sma30,
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: '45-Day MA',
                            data: sma45,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#cbd5e0' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e0',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                            grid: { color: '#334155' }
                        },
                        y: {
                            type: scaleSettings.dailyViews,
                            ticks: { 
                                color: '#94a3b8',
                                callback: v => formatNumber(v)
                            },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });

            // Chart 2: Monthly Growth
            const monthlyDates = monthly.map(m => m.month);
            const monthlyViews = monthly.map(m => m.total_views);
            const monthlyGrowth = monthly.map((m, i) => {
                if (i === 0) return 0;
                const prev = monthly[i - 1].total_views;
                return ((m.total_views - prev) / prev) * 100;
            });

            if (charts.monthlyGrowth) charts.monthlyGrowth.destroy();
            charts.monthlyGrowth = new Chart(document.getElementById('monthlyGrowthChart'), {
                type: 'bar',
                data: {
                    labels: monthlyDates,
                    datasets: [
                        {
                            label: 'Monthly Total Views',
                            data: monthlyViews,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'MoM Growth %',
                            data: monthlyGrowth,
                            type: 'line',
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#cbd5e0' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e0'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { 
                                color: '#94a3b8',
                                callback: v => formatNumber(v)
                            },
                            grid: { color: '#334155' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { 
                                color: '#10b981',
                                callback: v => v.toFixed(1) + '%'
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Chart 3: Stock Price
            if (charts.stockPrice) charts.stockPrice.destroy();
            charts.stockPrice = new Chart(document.getElementById('stockPriceChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Stock Price (‚Çπ)',
                            data: stockPrices,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true
                        },
                        {
                            label: '7-Day MA',
                            data: stockSma7,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: '30-Day MA',
                            data: stockSma30,
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: '45-Day MA',
                            data: stockSma45,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#cbd5e0' }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e0'
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                            grid: { color: '#334155' }
                        },
                        y: {
                            type: scaleSettings.stockPrice,
                            ticks: { 
                                color: '#94a3b8',
                                callback: v => '‚Çπ' + v.toFixed(2)
                            },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });

            // Chart 4: Side-by-Side Comparison
            if (charts.comparison) charts.comparison.destroy();
            charts.comparison = new Chart(document.getElementById('comparisonChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Views',
                            data: dailyViews,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 0,
                            yAxisID: 'y',
                            fill: true
                        },
                        {
                            label: 'Stock Price (‚Çπ)',
                            data: stockPrices,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 0,
                            yAxisID: 'y1',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { 
                                color: '#cbd5e0',
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e0',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8', maxTicksLimit: 15 },
                            grid: { color: '#334155' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Daily Views',
                                color: '#667eea',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: { 
                                color: '#667eea',
                                callback: v => formatNumber(v)
                            },
                            grid: { color: '#334155' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Stock Price (‚Çπ)',
                                color: '#8b5cf6',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: { 
                                color: '#8b5cf6',
                                callback: v => '‚Çπ' + v.toFixed(2)
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Update Table
        function updateTable() {
            const { unified } = allData;
            if (!unified || unified.length === 0) return;

            const filtered = unified.filter(d => d.stock_price > 0).slice(-100).reverse();
            
            let html = '';
            filtered.forEach((row, i) => {
                const prevRow = i < filtered.length - 1 ? filtered[i + 1] : null;
                const viewsChange = prevRow ? row.daily_views_change - prevRow.daily_views_change : 0;
                const viewsChangePct = prevRow && prevRow.daily_views_change !== 0 
                    ? ((viewsChange / prevRow.daily_views_change) * 100) 
                    : 0;

                const last7 = filtered.slice(Math.max(0, i - 6), i + 1).map(d => d.daily_views_change);
                const avg7 = last7.reduce((a, b) => a + b, 0) / last7.length;

                const last30 = filtered.slice(Math.max(0, i - 29), i + 1).map(d => d.daily_views_change);
                const avg30 = last30.reduce((a, b) => a + b, 0) / last30.length;

                html += `
                    <tr>
                        <td>${formatDate(row.date)}</td>
                        <td>${formatNumber(row.daily_views_change)}</td>
                        <td class="${viewsChange >= 0 ? 'positive' : 'negative'}">
                            ${viewsChange >= 0 ? '+' : ''}${formatNumber(viewsChange)}
                        </td>
                        <td class="${viewsChangePct >= 0 ? 'positive' : 'negative'}">
                            ${formatPercent(viewsChangePct)}
                        </td>
                        <td>${formatNumber(avg7)}</td>
                        <td>${formatNumber(avg30)}</td>
                        <td>‚Çπ${row.stock_price.toFixed(2)}</td>
                    </tr>
                `;
            });

            document.getElementById('dataTableBody').innerHTML = html;
        }

        // Correlation Analysis
        function updateCorrelationAnalysis() {
            const { unified } = allData;
            if (!unified || unified.length < 30) {
                document.getElementById('correlationInsight').textContent = 
                    'Insufficient data for correlation analysis';
                return;
            }

            const filtered = unified.filter(d => d.stock_price > 0 && d.daily_views_change > 0);
            const views = filtered.map(d => d.daily_views_change);
            const prices = filtered.map(d => d.stock_price);

            const correlation = calculateCorrelation(views, prices);
            const absCorr = Math.abs(correlation);
            
            let strength = 'Weak';
            if (absCorr > 0.7) strength = 'Strong';
            else if (absCorr > 0.4) strength = 'Moderate';

            // Calculate best lag (simplified)
            let bestLag = 0;
            let bestLagCorr = correlation;

            // Test lags from 1 to 30 days
            for (let lag = 1; lag <= 30; lag++) {
                if (lag >= views.length) break;
                const laggedViews = views.slice(0, -lag);
                const laggedPrices = prices.slice(lag);
                const lagCorr = calculateCorrelation(laggedViews, laggedPrices);
                
                if (Math.abs(lagCorr) > Math.abs(bestLagCorr)) {
                    bestLagCorr = lagCorr;
                    bestLag = lag;
                }
            }

            // Update UI
            document.getElementById('pearsonCorr').textContent = correlation.toFixed(3);
            document.getElementById('corrStrength').textContent = strength;
            document.getElementById('bestLag').textContent = `${bestLag} days`;
            document.getElementById('dataPoints').textContent = filtered.length;

            const interpretation = correlation > 0 
                ? 'positive correlation - higher daily views tend to coincide with higher stock prices'
                : 'negative correlation - higher daily views tend to coincide with lower stock prices';

            const recommendation = absCorr > 0.5
                ? 'üìà Strong correlation detected! Daily views could be a useful leading indicator for stock price movements. Consider analyzing the lag period for trading signals.'
                : absCorr > 0.3
                ? 'üìä Moderate correlation exists. While there is some relationship, additional factors should be considered for trading decisions.'
                : '‚ö†Ô∏è Weak correlation detected. Daily views alone may not be a reliable predictor of stock price movements. Consider analyzing monthly trends or other metrics.';

            document.getElementById('correlationInsight').innerHTML = `
                <strong>Pearson Correlation: ${correlation.toFixed(3)}</strong> (${strength} ${correlation > 0 ? 'positive' : 'negative'} correlation)<br><br>
                
                <strong>Interpretation:</strong> Tips Music daily views show a ${interpretation}. 
                With ${filtered.length} data points analyzed, the correlation coefficient of ${Math.abs(correlation).toFixed(3)} 
                indicates a ${strength.toLowerCase()} statistical relationship.<br><br>
                
                <strong>Best Lag Period:</strong> The strongest correlation (r = ${bestLagCorr.toFixed(3)}) was found when 
                comparing daily views with stock prices ${bestLag} days later. This suggests that changes in YouTube daily views 
                may precede stock price movements by approximately ${bestLag} days.<br><br>
                
                <strong>Recommendation:</strong> ${recommendation}
            `;
        }

        // Toggle Scale
        function toggleScale(chartType, scale) {
            scaleSettings[chartType] = scale;
            
            // Update button states
            const buttons = event.target.parentElement.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Redraw chart
            updateCharts();
        }

        // Initialize
        document.getElementById('endDate').valueAsDate = new Date();
        updateDateRange();
        
        window.addEventListener('load', () => {
            loadData();
        });
    </script>
</body>
</html>
