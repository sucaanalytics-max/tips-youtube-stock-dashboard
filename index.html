<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tips Music Analytics Dashboard - Advanced Financial Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }
        
        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #1a202c;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1em;
        }
        
        /* Key Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .metric-change {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .metric-change.positive {
            color: #38a169;
        }
        
        .metric-change.negative {
            color: #e53e3e;
        }
        
        /* Filters */
        .filters {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9em;
        }
        
        input[type="date"],
        select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(66, 153, 225, 0.3);
        }
        
        /* Charts */
        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #1a202c;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        
        .chart-controls button {
            padding: 8px 16px;
            font-size: 0.85em;
            background: #edf2f7;
            color: #2d3748;
        }
        
        .chart-controls button.active {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        /* Two-column layout for side-by-side */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Data Table */
        .data-table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }
        
        .data-table thead {
            background: #f7fafc;
        }
        
        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            background: #f7fafc;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table tr:hover {
            background: #f7fafc;
        }
        
        .positive { color: #38a169; font-weight: 600; }
        .negative { color: #e53e3e; font-weight: 600; }
        .neutral { color: #718096; }
        
        /* Correlation Analysis */
        .correlation-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .correlation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .correlation-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #4299e1;
        }
        
        .correlation-card h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .correlation-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #4299e1;
            margin: 10px 0;
        }
        
        .correlation-interpretation {
            color: #718096;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        .footer {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #718096;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                height: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .metric-value {
                font-size: 1.5em;
            }
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>üìä Tips Music Analytics Dashboard</h1>
            <p>Advanced Financial Analysis & Correlation Modeling | Data Science Driven</p>
        </div>

        <!-- Key Metrics Summary -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading key metrics...</p>
            </div>
        </div>

        <!-- Date Filters -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="timeframe">üìÖ Time Period</label>
                    <select id="timeframe" onchange="updateDateRange()">
                        <option value="30">Last 30 Days</option>
                        <option value="90" selected>Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last 1 Year</option>
                        <option value="all">All Time (2023-Present)</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" value="2024-01-01">
                </div>
                <div class="filter-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="loadData()">üîÑ Refresh Data</button>
                </div>
            </div>
        </div>

        <!-- Chart 1: Daily Views with Moving Averages -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">üìà Tips Music - Daily Views (with Moving Averages)</h3>
                <div class="chart-controls">
                    <button class="active" onclick="toggleScale('dailyViews', 'linear')">Linear</button>
                    <button onclick="toggleScale('dailyViews', 'logarithmic')">Log Scale</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="dailyViewsChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Stock Price with Moving Averages -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">üíπ TIPSMUSIC Stock Price (with Moving Averages)</h3>
                <div class="chart-controls">
                    <button class="active" onclick="toggleScale('stockPrice', 'linear')">Linear</button>
                    <button onclick="toggleScale('stockPrice', 'logarithmic')">Log Scale</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="stockPriceChart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Side-by-Side Comparison (Dual Axis) -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">üîó Side-by-Side: Daily Views vs Stock Price</h3>
            </div>
            <div class="chart-wrapper">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>

        <!-- Chart 4: Monthly Growth Analysis -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">üìä Monthly Views Growth Analysis (MoM)</h3>
            </div>
            <div class="chart-wrapper">
                <canvas id="monthlyGrowthChart"></canvas>
            </div>
        </div>

        <!-- Data Table: Daily Views with Changes -->
        <div class="data-table-container">
            <h3 class="chart-title">üìã Detailed Daily Data (Last 30 Days)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Daily Views</th>
                        <th>Change from Previous Day</th>
                        <th>% Change</th>
                        <th>7-Day MA</th>
                        <th>Stock Price (‚Çπ)</th>
                        <th>Stock Change (%)</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Correlation Analysis -->
        <div class="correlation-panel">
            <h3 class="chart-title">üî¨ Correlation Analysis: Views vs Stock Price</h3>
            <div class="correlation-grid" id="correlationGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Calculating correlations...</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            Last updated: <span id="lastUpdated">Loading...</span> | 
            Data from Supabase PostgreSQL | 
            Methodology: 7/30/45-day SMA, Pearson & Spearman Correlation
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        const charts = {};
        let allData = {};
        let scaleTypes = {
            dailyViews: 'linear',
            stockPrice: 'linear'
        };

        // ============ UTILITY FUNCTIONS ============
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }

        function formatPercent(val) {
            if (!val && val !== 0) return 'N/A';
            const num = parseFloat(val);
            const prefix = num >= 0 ? '+' : '';
            return prefix + num.toFixed(2) + '%';
        }

        function calculateSMA(data, period) {
            const sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    sma.push(null);
                } else {
                    const slice = data.slice(i - period + 1, i + 1);
                    const avg = slice.reduce((a, b) => a + b, 0) / period;
                    sma.push(avg);
                }
            }
            return sma;
        }

        function calculatePearsonCorrelation(x, y) {
            const n = x.length;
            const meanX = x.reduce((a, b) => a + b) / n;
            const meanY = y.reduce((a, b) => a + b) / n;

            const numerator = x.reduce((sum, xi, i) => 
                sum + (xi - meanX) * (y[i] - meanY), 0);
            
            const denomX = Math.sqrt(x.reduce((sum, xi) => 
                sum + Math.pow(xi - meanX, 2), 0));
            const denomY = Math.sqrt(y.reduce((sum, yi) => 
                sum + Math.pow(yi - meanY, 2), 0));

            return numerator / (denomX * denomY);
        }

        function calculateSpearmanCorrelation(x, y) {
            const rankX = getRanks(x);
            const rankY = getRanks(y);
            return calculatePearsonCorrelation(rankX, rankY);
        }

        function getRanks(arr) {
            const sorted = [...arr].map((val, idx) => ({ val, idx }))
                .sort((a, b) => a.val - b.val);
            const ranks = new Array(arr.length);
            sorted.forEach((item, rank) => {
                ranks[item.idx] = rank + 1;
            });
            return ranks;
        }

        function calculateLagCorrelation(x, y, maxLag = 30) {
            const results = [];
            for (let lag = 0; lag <= maxLag; lag++) {
                if (lag >= x.length) break;
                const xLagged = x.slice(0, x.length - lag);
                const yLagged = y.slice(lag);
                const corr = calculatePearsonCorrelation(xLagged, yLagged);
                results.push({ lag, correlation: corr });
            }
            return results;
        }

        function updateDateRange() {
            const timeframe = document.getElementById('timeframe').value;
            const endDate = new Date();
            const startDate = new Date();

            if (timeframe === 'all') {
                startDate.setFullYear(2023, 0, 1);
            } else if (timeframe !== 'custom') {
                startDate.setDate(endDate.getDate() - parseInt(timeframe));
            }

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
        }

        async function fetchSupabase(view, filters = {}, orderBy = null, limit = 2000) {
            let url = `${SUPABASE_URL}/rest/v1/${view}?select=*`;
            
            Object.keys(filters).forEach(key => {
                url += `&${key}=eq.${encodeURIComponent(filters[key])}`;
            });
            
            if (orderBy) url += `&order=${orderBy}`;
            if (limit) url += `&limit=${limit}`;

            try {
                const response = await axios.get(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                return response.data;
            } catch (error) {
                console.error(`Error fetching ${view}:`, error);
                return [];
            }
        }

        // ============ DATA LOADING ============
        async function loadData() {
            try {
                // Fetch all necessary data
                const [dailyStats, stockPrices, monthlyTotals] = await Promise.all([
                    fetchSupabase('daily_stats', { label: 'Tips' }, 'date.desc', 2000),
                    fetchSupabase('stock_prices', { symbol: 'TIPSMUSIC' }, 'date.desc', 2000),
                    fetchSupabase('monthly_label_totals', { label: 'Tips' }, 'month.desc', 50)
                ]);

                // Process and merge data
                const mergedData = processDailyData(dailyStats, stockPrices);
                
                allData = {
                    daily: mergedData,
                    monthly: monthlyTotals,
                    rawDaily: dailyStats,
                    rawStock: stockPrices
                };

                // Update all visualizations
                updateKeyMetrics();
                updateDailyViewsChart();
                updateStockPriceChart();
                updateComparisonChart();
                updateMonthlyGrowthChart();
                updateDataTable();
                updateCorrelationAnalysis();

                document.getElementById('lastUpdated').textContent = 
                    new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Please check console for details.');
            }
        }

        function processDailyData(dailyStats, stockPrices) {
            // Create a map of stock prices by date
            const stockMap = new Map();
            stockPrices.forEach(sp => {
                if (sp.close && sp.close > 0) {
                    stockMap.set(sp.date, sp);
                }
            });

            // Merge daily stats with stock prices
            return dailyStats
                .map(day => {
                    const stock = stockMap.get(day.date);
                    return {
                        date: day.date,
                        views: day.views || 0,
                        subscribers: day.subscribers || 0,
                        stockPrice: stock ? stock.close : null,
                        stockOpen: stock ? stock.open : null,
                        stockHigh: stock ? stock.high : null,
                        stockLow: stock ? stock.low : null,
                        stockVolume: stock ? stock.volume : null
                    };
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // ============ KEY METRICS ============
        function updateKeyMetrics() {
            const { daily, monthly } = allData;
            if (!daily || daily.length === 0) return;

            const latest = daily[daily.length - 1];
            const previous = daily[daily.length - 2];
            const lastWeek = daily[daily.length - 8];
            const lastMonth = daily[daily.length - 31];

            const viewsChange = previous ? latest.views - previous.views : 0;
            const viewsChangePct = previous ? ((viewsChange / previous.views) * 100) : 0;
            
            const stockChange = previous && latest.stockPrice && previous.stockPrice ? 
                latest.stockPrice - previous.stockPrice : 0;
            const stockChangePct = previous && previous.stockPrice ? 
                ((stockChange / previous.stockPrice) * 100) : 0;

            const avgDailyViews = daily.slice(-30).reduce((sum, d) => sum + d.views, 0) / 30;
            const weeklyGrowth = lastWeek ? 
                (((latest.views - lastWeek.views) / lastWeek.views) * 100) : 0;

            const html = `
                <div class="metric-card">
                    <div class="metric-label">Latest Daily Views</div>
                    <div class="metric-value">${formatNumber(latest.views)}</div>
                    <div class="metric-change ${viewsChange >= 0 ? 'positive' : 'negative'}">
                        ${viewsChange >= 0 ? '‚ñ≤' : '‚ñº'} ${formatNumber(Math.abs(viewsChange))} (${formatPercent(viewsChangePct)})
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Stock Price (Latest)</div>
                    <div class="metric-value">‚Çπ${latest.stockPrice ? latest.stockPrice.toFixed(2) : 'N/A'}</div>
                    <div class="metric-change ${stockChange >= 0 ? 'positive' : 'negative'}">
                        ${stockChange >= 0 ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(stockChange).toFixed(2)} (${formatPercent(stockChangePct)})
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">30-Day Avg Daily Views</div>
                    <div class="metric-value">${formatNumber(avgDailyViews)}</div>
                    <div class="metric-change neutral">
                        Rolling average (last 30 days)
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">7-Day Growth Rate</div>
                    <div class="metric-value">${formatPercent(weeklyGrowth)}</div>
                    <div class="metric-change ${weeklyGrowth >= 0 ? 'positive' : 'negative'}">
                        ${weeklyGrowth >= 0 ? 'üìà' : 'üìâ'} Week-over-week change
                    </div>
                </div>
            `;

            document.getElementById('metricsGrid').innerHTML = html;
        }

        // ============ CHART 1: DAILY VIEWS ============
        function updateDailyViewsChart() {
            const { daily } = allData;
            if (!daily || daily.length === 0) return;

            const data = daily.slice(-365); // Last year
            const dates = data.map(d => d.date);
            const views = data.map(d => d.views);
            const sma7 = calculateSMA(views, 7);
            const sma30 = calculateSMA(views, 30);
            const sma45 = calculateSMA(views, 45);

            if (charts.dailyViews) charts.dailyViews.destroy();

            charts.dailyViews = new Chart(document.getElementById('dailyViewsChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Views',
                            data: views,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '7-Day SMA',
                            data: sma7,
                            borderColor: '#48bb78',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: '30-Day SMA',
                            data: sma30,
                            borderColor: '#ed8936',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: '45-Day SMA',
                            data: sma45,
                            borderColor: '#9f7aea',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [10, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: scaleTypes.dailyViews,
                            beginAtZero: true,
                            ticks: {
                                callback: v => formatNumber(v)
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }

        // ============ CHART 2: STOCK PRICE ============
        function updateStockPriceChart() {
            const { daily } = allData;
            if (!daily || daily.length === 0) return;

            // Filter out null/zero stock prices
            const data = daily.filter(d => d.stockPrice && d.stockPrice > 0).slice(-365);
            const dates = data.map(d => d.date);
            const prices = data.map(d => d.stockPrice);
            const sma7 = calculateSMA(prices, 7);
            const sma30 = calculateSMA(prices, 30);
            const sma45 = calculateSMA(prices, 45);

            if (charts.stockPrice) charts.stockPrice.destroy();

            charts.stockPrice = new Chart(document.getElementById('stockPriceChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Stock Price (‚Çπ)',
                            data: prices,
                            borderColor: '#805ad5',
                            backgroundColor: 'rgba(128, 90, 213, 0.1)',
                            borderWidth: 2,
                            pointRadius: 1,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '7-Day SMA',
                            data: sma7,
                            borderColor: '#48bb78',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: '30-Day SMA',
                            data: sma30,
                            borderColor: '#ed8936',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: '45-Day SMA',
                            data: sma45,
                            borderColor: '#f56565',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            borderDash: [10, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ‚Çπ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: scaleTypes.stockPrice,
                            ticks: {
                                callback: v => '‚Çπ' + v.toFixed(0)
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }

        // ============ CHART 3: SIDE-BY-SIDE COMPARISON ============
        function updateComparisonChart() {
            const { daily } = allData;
            if (!daily || daily.length === 0) return;

            const data = daily.filter(d => d.stockPrice && d.stockPrice > 0).slice(-180);
            const dates = data.map(d => d.date);
            const views = data.map(d => d.views);
            const prices = data.map(d => d.stockPrice);

            if (charts.comparison) charts.comparison.destroy();

            charts.comparison = new Chart(document.getElementById('comparisonChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Daily Views',
                            data: views,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Stock Price (‚Çπ)',
                            data: prices,
                            borderColor: '#805ad5',
                            backgroundColor: 'rgba(128, 90, 213, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Daily Views'
                            },
                            ticks: {
                                callback: v => formatNumber(v)
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Stock Price (‚Çπ)'
                            },
                            ticks: {
                                callback: v => '‚Çπ' + v.toFixed(0)
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }

        // ============ CHART 4: MONTHLY GROWTH ============
        function updateMonthlyGrowthChart() {
            const { monthly } = allData;
            if (!monthly || monthly.length === 0) return;

            const data = monthly.slice(0, 12).reverse();
            const months = data.map(d => d.month);
            const views = data.map(d => d.total_views);
            const momGrowth = data.map(d => d.mom_views_growth_pct || 0);

            if (charts.monthlyGrowth) charts.monthlyGrowth.destroy();

            charts.monthlyGrowth = new Chart(document.getElementById('monthlyGrowthChart'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Monthly Total Views',
                            data: views,
                            backgroundColor: 'rgba(66, 153, 225, 0.7)',
                            borderColor: '#4299e1',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'MoM Growth %',
                            data: momGrowth,
                            type: 'line',
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#48bb78',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Total Monthly Views'
                            },
                            ticks: {
                                callback: v => formatNumber(v)
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'MoM Growth %'
                            },
                            ticks: {
                                callback: v => v.toFixed(1) + '%'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // ============ DATA TABLE ============
        function updateDataTable() {
            const { daily } = allData;
            if (!daily || daily.length === 0) return;

            const last30Days = daily.slice(-30);
            const rows = last30Days.map((day, idx) => {
                const prev = idx > 0 ? last30Days[idx - 1] : null;
                const viewsChange = prev ? day.views - prev.views : 0;
                const viewsChangePct = prev && prev.views ? ((viewsChange / prev.views) * 100) : 0;
                const stockChange = prev && day.stockPrice && prev.stockPrice ? 
                    ((day.stockPrice - prev.stockPrice) / prev.stockPrice) * 100 : null;

                const sma7 = idx >= 6 ? 
                    last30Days.slice(idx - 6, idx + 1).reduce((sum, d) => sum + d.views, 0) / 7 : null;

                return `
                    <tr>
                        <td>${day.date}</td>
                        <td>${formatNumber(day.views)}</td>
                        <td class="${viewsChange >= 0 ? 'positive' : 'negative'}">
                            ${viewsChange >= 0 ? '+' : ''}${formatNumber(viewsChange)}
                        </td>
                        <td class="${viewsChangePct >= 0 ? 'positive' : 'negative'}">
                            ${formatPercent(viewsChangePct)}
                        </td>
                        <td>${sma7 ? formatNumber(sma7) : 'N/A'}</td>
                        <td>${day.stockPrice ? '‚Çπ' + day.stockPrice.toFixed(2) : 'N/A'}</td>
                        <td class="${stockChange && stockChange >= 0 ? 'positive' : 'negative'}">
                            ${stockChange !== null ? formatPercent(stockChange) : 'N/A'}
                        </td>
                    </tr>
                `;
            }).reverse().join('');

            document.getElementById('dataTableBody').innerHTML = rows;
        }

        // ============ CORRELATION ANALYSIS ============
        function updateCorrelationAnalysis() {
            const { daily } = allData;
            if (!daily || daily.length === 0) return;

            const data = daily.filter(d => d.stockPrice && d.stockPrice > 0);
            const views = data.map(d => d.views);
            const prices = data.map(d => d.stockPrice);

            // Calculate correlations
            const pearson = calculatePearsonCorrelation(views, prices);
            const spearman = calculateSpearmanCorrelation(views, prices);
            
            // Lag correlation
            const lagResults = calculateLagCorrelation(views, prices, 30);
            const bestLag = lagResults.reduce((best, current) => 
                Math.abs(current.correlation) > Math.abs(best.correlation) ? current : best
            );

            // Rolling 30-day correlation
            const rollingCorr = [];
            for (let i = 30; i < data.length; i++) {
                const windowViews = views.slice(i - 30, i);
                const windowPrices = prices.slice(i - 30, i);
                const corr = calculatePearsonCorrelation(windowViews, windowPrices);
                rollingCorr.push(corr);
            }
            const avgRollingCorr = rollingCorr.reduce((a, b) => a + b, 0) / rollingCorr.length;

            // Interpretation
            const getStrength = (r) => {
                const abs = Math.abs(r);
                if (abs > 0.7) return 'Strong';
                if (abs > 0.4) return 'Moderate';
                return 'Weak';
            };

            const getDirection = (r) => r > 0 ? 'Positive' : 'Negative';

            const html = `
                <div class="correlation-card">
                    <h4>üìä Pearson Correlation</h4>
                    <div class="correlation-value">${pearson.toFixed(4)}</div>
                    <div class="correlation-interpretation">
                        <strong>${getStrength(pearson)} ${getDirection(pearson)}</strong> linear relationship<br>
                        Measures: Direct proportional relationship
                    </div>
                </div>
                <div class="correlation-card">
                    <h4>üìà Spearman Correlation</h4>
                    <div class="correlation-value">${spearman.toFixed(4)}</div>
                    <div class="correlation-interpretation">
                        <strong>${getStrength(spearman)} ${getDirection(spearman)}</strong> monotonic relationship<br>
                        Measures: Rank-based correlation (non-linear trends)
                    </div>
                </div>
                <div class="correlation-card">
                    <h4>‚è±Ô∏è Best Lag Period</h4>
                    <div class="correlation-value">${bestLag.lag} days</div>
                    <div class="correlation-interpretation">
                        <strong>Correlation: ${bestLag.correlation.toFixed(4)}</strong><br>
                        Views from ${bestLag.lag} days ago best predict today's stock price
                    </div>
                </div>
                <div class="correlation-card">
                    <h4>üîÑ Rolling 30-Day Avg</h4>
                    <div class="correlation-value">${avgRollingCorr.toFixed(4)}</div>
                    <div class="correlation-interpretation">
                        <strong>${getStrength(avgRollingCorr)}</strong> average correlation<br>
                        Stability measure over time windows
                    </div>
                </div>
                <div class="correlation-card" style="grid-column: 1 / -1;">
                    <h4>üí° Expert Interpretation & Trading Recommendations</h4>
                    <div class="correlation-interpretation" style="line-height: 1.8;">
                        ${Math.abs(pearson) > 0.5 ? 
                            `<strong>‚úÖ Significant Correlation Detected:</strong> The ${getDirection(pearson).toLowerCase()} correlation of ${pearson.toFixed(3)} suggests YouTube views ${pearson > 0 ? 'positively influence' : 'inversely relate to'} stock price movements. Consider views as a ${Math.abs(pearson) > 0.6 ? 'strong' : 'moderate'} leading indicator.` :
                            `<strong>‚ö†Ô∏è Weak Correlation:</strong> With correlation of ${pearson.toFixed(3)}, YouTube views alone are not a reliable predictor. Consider combining with other fundamental/technical indicators.`
                        }
                        <br><br>
                        <strong>Lag Analysis:</strong> The optimal lag of ${bestLag.lag} days (r=${bestLag.correlation.toFixed(3)}) suggests views changes take approximately ${bestLag.lag} days to reflect in stock price. ${bestLag.lag < 7 ? 'This is a short-term effect.' : bestLag.lag < 14 ? 'This represents a medium-term momentum.' : 'This indicates a longer-term trend.'}
                        <br><br>
                        <strong>Statistical Significance:</strong> Based on ${data.length} data points. ${Math.abs(pearson) > 0.3 && data.length > 30 ? 'Statistically significant at p<0.05.' : 'May require more data for statistical confidence.'}
                    </div>
                </div>
            `;

            document.getElementById('correlationGrid').innerHTML = html;
        }

        // ============ TOGGLE SCALE ============
        function toggleScale(chartName, scale) {
            scaleTypes[chartName] = scale;
            
            // Update button states
            const container = document.querySelector(`#${chartName}Chart`).closest('.chart-section');
            const buttons = container.querySelectorAll('.chart-controls button');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if ((scale === 'linear' && btn.textContent.includes('Linear')) ||
                    (scale === 'logarithmic' && btn.textContent.includes('Log'))) {
                    btn.classList.add('active');
                }
            });

            // Redraw appropriate chart
            if (chartName === 'dailyViews') {
                updateDailyViewsChart();
            } else if (chartName === 'stockPrice') {
                updateStockPriceChart();
            }
        }

        // ============ INITIALIZATION ============
        document.getElementById('endDate').valueAsDate = new Date();
        updateDateRange();
        
        window.addEventListener('load', () => {
            loadData();
        });
    </script>
</body>
</html>
